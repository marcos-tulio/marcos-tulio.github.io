<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset='utf-8'>
		<meta http-equiv='X-UA-Compatible' content='IE=edge'>
		<title>Projetos por Marcos Santos</title>
		<meta name='viewport' content='width=device-width, initial-scale=1'>
		<script src="https://cdn.tailwindcss.com/3.2.4"></script>
        <script src="https://code.jquery.com/jquery-3.6.4.slim.min.js"></script>
        <script src="js/simple-mask-money.umd.js"></script>
        <link rel="stylesheet" href="css/fees_calculator.css">
	</head>
	<body>
		<div class="flex flex-col bg-neutral-800 text-white min-h-screen h-fit">
			<!-- Title -->
			<div class="bg-teal-600 flex min-h-[200px] mb-5">
				<div class="flex flex-col m-auto text-center">
					<div class="text-5xl my-4 font-bold w-fit mx-auto"><h1 class="bg-neutral-800 p-3">Calculadora de Juros</h1></div>
					<!-- <span>Calculadora de Juros .</span> -->
				</div>
			</div>

			<!-- Content -->
            <div class="content">
                <div class="header">
                    <button id="basic" class="selected">Juros Simples</button>
                    <button id="advanced">Juros Compostos</button>
                </div>

                <form>
                    <div>
                        <label>Montante</label>
                        <input id="amount"/>
                    </div>

                    <div>
                        <label>Capital</label>
                        <input id="capital"/>
                    </div>

                    <div>
                        <label>Juros</label>
                        <input id="fees"/>
                    </div>

                    <div>
                        <div class="tooltip">
                            <label>Taxa</label>
                            <span class="tooltiptext" id="tax-tooltip">Aqui será exibida a taxa convertida</span>
                        </div>
                        
                        <div class="selector">                            
                            <input id="tax" data-thousands="." data-decimal="," data-suffix="%"/>                        

                            <select name="taxs" id="taxs">
                                <option value="1"   value="day">ao dia (a.d.)</option>
                                <option value="30"  value="month">ao mês (a.m.)</option>
                                <option value="60"  value="two-months">ao bimestre (a.b.)</option>
                                <option value="90"  value="quarter">ao trimestre (a.t.)</option>
                                <option value="180" value="semester">ao semestre (a.s.)</option>
                                <option value="360" value="year">ao ano (a.a.)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <div class="tooltip">
                            <label>Período</label>
                            <span class="tooltiptext" id="period-tooltip">Aqui será exibido o período convertido</span>
                        </div>

                        <div class="selector">
                            <input id="period"/>                     

                            <select name="periods" id="periods">
                                <option value="1"   value="day">dia</option>
                                <option value="30"  value="month">mês</option>
                                <option value="60"  value="two-months">bimestre</option>
                                <option value="90"  value="quarter">trimestre</option>
                                <option value="180" value="semester">semestre</option>
                                <option value="360" value="year">ano</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex mt-4">
                        <div class="m-auto">
                            <button id="clear" >Limpar</button>
                            <button id="calculate" >Calcular</button>
                        </div>
                    </div>
                </form>
            </div>

			<footer class="mb-0 mt-auto text-center p-4 text-sm">Desenvolvido por <a href="https://github.com/marcos-tulio"><span class="text-teal-600 font-bold">Marcos Santos</span></a></footer>
		</div>

        <script>
            $(function() {

                let level = "basic"

                const mask = {
                    money  : {
                        afterFormat(e) { onChangeValidation(e) },
                        allowNegative: true,
                        beforeFormat(e) {  },
                        negativeSignAfter: false,
                        prefix: 'R$ ',
                        suffix: '',
                        fixed: true,
                        fractionDigits: 2,
                        decimalSeparator: ',',
                        thousandsSeparator: '.',
                        cursor: 'end'
                    },
                    tax : { 
                        thousandsSeparator:'', 
                        decimalSeparator: ',', 
                        suffix: '%', 
                        allowNegative: true,
                        fractionDigits: 4,
                        afterFormat(e) { onChangeValidation(e) },
                    },
                    period : { 
                        thousandsSeparator:'', 
                        decimalSeparator: ',',
                        allowNegative: true,
                        afterFormat(e) { onChangeValidation(e) },
                    },
                    type : {
                        fees   : {},
                        amount : {},
                        capital: {},
                        tax    : {},
                        period : {},
                    }
                }

                mask.type.fees    = mask.money;
                mask.type.amount  = mask.money;
                mask.type.capital = mask.money;
                mask.type.tax     = mask.tax;
                mask.type.period  = mask.period;

                function getValues(){
                    const input_amount  = $("#amount")
                    const input_capital = $("#capital")
                    const input_fees    = $("#fees")
                    const input_tax     = $("#tax")
                    const input_period  = $("#period")

                    const amount  = parseFloat( SimpleMaskMoney.formatToNumber(input_amount[0].value))
                    const capital = parseFloat( SimpleMaskMoney.formatToNumber(input_capital[0].value))
                    const fees    = parseFloat( SimpleMaskMoney.formatToNumber(input_fees[0].value))
                    const tax     = parseFloat( SimpleMaskMoney.formatToNumber(input_tax[0].value))
                    const period  = parseFloat( SimpleMaskMoney.formatToNumber(input_period[0].value))

                    const days_from_tax_selected    = $("#taxs").find(":selected").val();
                    const days_from_period_selected = $("#periods").find(":selected").val();

                    // Adaptar taxa e período em dias
                    const tax_formatted    = taxFromDays( tax, days_from_tax_selected )
                    const period_formatter = periodToDays( period, days_from_period_selected )
                    //const [tax_formatted, period_formatter] = calculateTaxs(tax, days_from_tax_selected, period, days_from_period_selected)

                    return {
                        input: {
                            amount  : input_amount,
                            capital : input_capital,
                            fees    : input_fees,
                            tax     : input_tax,
                            period  : input_period
                        },
                        value: {
                            amount  : amount,
                            capital : capital,
                            fees    : fees,
                            tax     : tax_formatted,
                            period  : period_formatter,
                        }
                    }
                }

                function refreshMasks() {
                    refreshMask( 'amount' )
                    refreshMask( 'capital')
                    refreshMask( 'fees'   )
                    refreshMask( 'tax'    )
                    refreshMask( 'period' )
                }

                function refreshMask( id, isUpdated = true ) {
                    const _mask = {...mask.type[id]}

                    if ( !isUpdated ) {
                        _mask.beforeFormat = () =>{}
                        _mask.afterFormat  = () =>{}
                    }

                    SimpleMaskMoney.removeMask('#' + id)()
                    SimpleMaskMoney.setMask( '#' + id, _mask )
                    
                    if ( $('#' + id)[0].blocked ) $('#' + id)[0].disabled = true
                }

                function enableFields(enabled = true) {
                    $('input, select, #calculate').each(function() {
                        $(this).prop('disabled', !enabled);
                    });
                }

                function onChangeValidation(e){

                    const check = {
                        fees   : {
                            filters: [
                                { 
                                    conditions: ['amount', 'capital'], 
                                    blocked   : [/*'tax', 'period'*/], 
                                    ignore    : [] 
                                },
                                { 
                                    conditions: ['capital', 'tax', 'period'] , 
                                    blocked   : ['amount'],
                                    ignore    : []
                                }
                            ],
                            doAction  : calculateFees,
                        },
                        capital: {
                            filters: [
                                { 
                                    conditions: ['fees', 'amount'], 
                                    blocked   : [],
                                    ignore    : [] 
                                },
                            ],
                            doAction  : calculateCapital,
                        },                        
                        amount : {
                            filters: [
                                { 
                                    conditions: ['fees', 'capital'], 
                                    blocked   : [],
                                    ignore    : [] 
                                },
                            ],
                            doAction  : calculateAmount,
                        },
                        tax    : {
                            filters: [
                                { 
                                    conditions: ['fees', 'capital', 'period'], 
                                    blocked   : [],
                                    ignore    : ['fees'] 
                                },
                            ],
                            doAction  : calculateTax,
                        },
                        period : {
                            filters: [
                                { 
                                    conditions: ['fees', 'capital', 'tax'], 
                                    blocked   : [],
                                    ignore    : [] 
                                },
                            ],
                            doAction  : calculatePeriod,
                        }
                    }

                    const functionCheck = ([key, value]) => {
                        let needCleaned = true

                        value.filters.forEach( filter => {

                            const needCalculate = filter.conditions.every( c => data.value[c] && !data.input[c][0].disabled )
                            
                            //console.log( "Tentando... Calculate '" + key + "',  filters: " + filter.conditions.join(", "), data.value )
                            //console.log( data )

                            if ( needCalculate ) {
                                filter.blocked.forEach( c => { data.input[c][0].blocked = data.input[c][0].disabled = true } )

                                console.log( "Calculate '" + key + "',  filters: " + filter.conditions.join(", "), data.value )

                                needCleaned = false

                                value.doAction( data = data, disable = true, update = false )    
                                return
                            }
                        })

                        // limpar campo
                        if ( needCleaned && data.input[key][0].disabled && !data.input[key][0].blocked ) {
                            data.value[key] = 0
                            
                            value.doAction( data = data, disable = false, update = true )

                            value.filters.forEach( f => { f.blocked.forEach( c => { 
                                data.input[c][0].disabled = data.input[c][0].blocked = false
                            })} )

                            return
                        }
                    }

                    let data = getValues()

                    Object.entries(check).forEach( functionCheck )
                }

                function changeLevel(e){
                    e.preventDefault()
                    level = e.target.id

                    $("#basic").removeClass("selected")
                    $("#advanced").removeClass("selected")

                    $(e.target).addClass("selected")

                    onChangeValidation(e)
                }

                function truncateDecimals(num, digits) {
                    let numS = num.toString(),
                        decPos = numS.indexOf('.'),
                        substrLength = decPos == -1 ? numS.length : 1 + decPos + digits,
                        trimmedResult = numS.substr(0, substrLength),
                        finalResult = isNaN(trimmedResult) ? 0 : trimmedResult;

                    return (parseFloat(finalResult) + "").replace('.', ',');
                }

                function updateTooltips( periodInDays, tax ){
                    $("#period-tooltip").html( periodInDays + " dias")

                    if ( tax ){
                        $("#tax-tooltip").html(
                            truncateDecimals( taxToDays(tax, 1  ), 5 ) + "% a.d." + "<br>" + 
                            truncateDecimals( taxToDays(tax, 30 ), 5 ) + "% a.m." + "<br>" + 
                            truncateDecimals( taxToDays(tax, 60 ), 5 ) + "% a.b." + "<br>" + 
                            truncateDecimals( taxToDays(tax, 90 ), 5 ) + "% a.t." + "<br>" + 
                            truncateDecimals( taxToDays(tax, 180), 5 ) + "% a.s." + "<br>" +
                            truncateDecimals( taxToDays(tax, 360), 5 ) + "% a.a." + "<br>"
                        ) 
                    } else $("#tax-tooltip").html("Aqui será exibida a taxa convertida")
                }

                /*function convertTax(isBasic, tax, days){
                    if ( isBasic ) return tax * days

                    return (Math.pow( (1 + tax/100), (days) ) - 1) * 100;
                }

                function calculateTaxs(tax, tax_selected, period, period_selected){
                    return (level === "basic") 
                            ? [ tax / tax_selected, period * period_selected ] // Juros Simples
                            : [ (Math.pow( (1 + tax/100), (1/tax_selected) ) - 1) * 100, period * period_selected]; // Juros compostos
                }*/

                function taxFromDays( tax, days ){
                    return (level === "basic") 
                            ? tax / days // Juros Simples
                            : (Math.pow( (1 + tax/100), (1/days) ) - 1) * 100 // Juros compostos
                }

                function taxToDays( tax, days ){
                    return ( level === "basic" ) 
                        ? ( tax * days )
                        : ( Math.pow( (1 + tax/100), (days) ) - 1) * 100
                }

                function periodFromDays( period, period_selected ){
                    return period_selected / period
                }

                function periodToDays( period, period_selected ){
                    return period * period_selected
                }

                function mathLog(x, y) {
                    return Math.log(y) / Math.log(x);
                }

                function calculateFees( data = data, disable = true, update = false ){
                    if ( !data ) data = getValues()

                    // Calcular com base no capital e o montante
                    if ( data.value.capital && data.value.amount )
                        data.value.fees = data.value.amount - data.value.capital; 

                    // Calcular com base no capital, a taxa e o período
                    if ( data.value.capital && data.value.tax && data.value.period ){
                        data.value.fees = (level === "basic") 
                            ? data.value.capital * (data.value.tax/100) * data.value.period // J = C . i . t
                            : data.value.capital * (Math.pow( (1 + data.value.tax/100), data.value.period) - 1); // J = C . (1 + i )^ t - C
                        
                        calculateAmount( data = data, disable = true, update = false )
                        //data.input.amount[0].ignored = true
                    }

                    data.input.fees[0].disabled = disable
                    data.input.fees.val( SimpleMaskMoney.formatToCurrency(data.value.fees, mask.type.fees) )

                    refreshMask('fees', update)
                }

                function calculateCapital( data = data, disable = true, update = false ){
                    if ( !data ) data = getValues()

                    // Calcular com base no montante e os juros
                    if ( data.value.amount && data.value.fees ){
                        data.value.capital = data.value.amount - data.value.fees
                    }

                    // Calcular com base no montante, a taxa e o período
                    else if ( data.value.amount && data.value.tax && data.value.period ){
                        data.value.capital = (level === "basic") 
                            ? (data.value.amount / (1 + (data.value.tax/100) * data.value.period))  // C = M / (1 + i . t)
                            : (data.value.amount / (1 + Math.pow(1 + (data.value.tax/100), data.value.period)) ); // C = M / (1 + (1 + i)^t)
                            
                        //fees = amount - capital
                        //calculateFees( data = data, disable = true, update = false )
                    }

                    // Calcular com base nos juros, a taxa e o período
                    else if ( data.value.fees && data.value.tax && data.value.period ){
                        data.value.capital = (level === "basic") 
                            ? (data.value.fees / ((data.value.tax/100) * data.value.period) ) // C = J/i.t.
                            : (data.value.fees / Math.pow( (1 + (data.value.tax/100)), data.value.period) ); // C = J/(1 + i)^t

                        //amount = fees + capital;
                        //calculateAmount( data = data, disable = true, update = false )
                    }

                    data.input.capital[0].disabled = disable
                    data.input.capital.val( SimpleMaskMoney.formatToCurrency(data.value.capital, mask.type.capital) )

                    refreshMask('capital', update)
                }

                function calculateAmount( data = data, disable = true, update = false){
                    if ( !data ) data = getValues()

                    // Calcular com base no capital e os juros
                    if ( data.value.capital && data.value.fees ){
                        data.value.amount = data.value.capital + data.value.fees
                    }

                    data.input.amount[0].disabled = disable
                    data.input.amount.val( SimpleMaskMoney.formatToCurrency(data.value.amount, mask.type.amount) )

                    refreshMask('amount', update)
                }

                function calculateTax( data = data, disable = true, update = false ){
                    if ( !data ) data = getValues()

                    if ( data.value.fees && data.value.capital && data.value.period ){

                        data.value.tax = (level === "basic") 
                            ? (data.value.fees / (data.value.capital * data.value.period)) * 100 // i = J / (C.t)
                            : (Math.pow( (data.value.fees + data.value.capital)/data.value.capital, (1/data.value.period) ) - 1) * 100 // i = (J/C)^(1/t)-1       

                        const days_from_tax_selected    = $("#taxs").find(":selected").val()
                        data.value.tax = taxToDays(data.value.tax, days_from_tax_selected)
                    }

                    data.input.tax[0].disabled = disable
                    data.input.tax.val( SimpleMaskMoney.formatToCurrency(data.value.tax, mask.type.tax) )

                    refreshMask('tax', update)
                    updateTooltips( data.value.period, data.value.tax )
                }

                function calculatePeriod( data = data, disable = true, update = false ){
                    if ( !data ) data = getValues()

                    if ( data.value.fees && data.value.capital && data.value.tax ){

                        data.value.period = (level === "basic") 
                            ? (data.value.fees / (data.value.capital * (data.value.tax/100))) // t = J / (C.i)
                            : mathLog( (1 + (data.value.tax/100)), ((data.value.fees + data.value.capital) / data.value.capital) )// log_(1+i) ((J+C)/C) 

                        const days_from_period_selected = $("#periods").find(":selected").val()
                        data.value.period = periodFromDays( data.value.period, days_from_period_selected )
                    }

                    data.input.period[0].disabled = disable
                    data.input.period.val( SimpleMaskMoney.formatToCurrency(data.value.period, mask.type.period) )

                    refreshMask('period', update)
                    updateTooltips( data.value.period, data.value.tax )
                }

                $("#calculate").click(function(e){
                    e.preventDefault();

                    let amount  = parseFloat( SimpleMaskMoney.formatToNumber($("#amount")[0].value)  );
                    let capital = parseFloat( SimpleMaskMoney.formatToNumber($("#capital")[0].value) );
                    let fees    = parseFloat( SimpleMaskMoney.formatToNumber($("#fees")[0].value)    );
                    let tax     = parseFloat( SimpleMaskMoney.formatToNumber($("#tax")[0].value)     );
                    let period  = parseFloat( SimpleMaskMoney.formatToNumber($("#period")[0].value)  );

                    let days_from_tax_selected    = $("#taxs").find(":selected").val();
                    let days_from_period_selected = $("#periods").find(":selected").val();

                    // Adaptar taxa e período em dias
                    let tax_formatted = tax;
                    let period_formatter = period; 
                    [tax_formatted, period_formatter] = calculateTaxs(tax, days_from_tax_selected, period, days_from_period_selected);

                    // Encontrar a Taxa
                    if ( !tax ){
                        if ( !capital && (amount && fees) )
                            capital = amount - fees;

                        tax = (level === "basic") 
                            ? (fees / (capital * period)) * 100 // i = J / (C.t)
                            : (Math.pow( (fees + capital)/capital, (1/period) ) - 1) * 100; // i = (J/C)^(1/t)-1

                        days_from_tax_selected = days_from_period_selected;
                        [tax_formatted, period_formatter] = calculateTaxs(tax, days_from_tax_selected, period, days_from_period_selected);
                    }

                    // Calcular o período
                    if ( !period ){
                        period = (level === "basic") 
                            ? (fees / (capital * (tax/100))) // t = J / (C.i)
                            : mathLog( (1 + (tax/100)), ((fees + capital) / capital) ) ; // log_(1+i) ((J+C)/C) 

                        days_from_period_selected = days_from_tax_selected;
                        [tax_formatted, period_formatter] = calculateTaxs(tax, days_from_tax_selected, period, days_from_period_selected);
                    }

                    // Calcular o Montante
                    if ( !amount && (capital && fees) ){
                        amount = capital + fees; // M = C + J
                    }

                    /* Calcular período e taxa equivalentes */
                    $("#period-tooltip").html(
                        truncateDecimals( period_formatter      , 2 ) + " dias"       + "<br>" + 
                        truncateDecimals( period_formatter / 30 , 2 ) + " meses"      + "<br>" + 
                        truncateDecimals( period_formatter / 60 , 2 ) + " bimestres"  + "<br>" + 
                        truncateDecimals( period_formatter / 90 , 2 ) + " trimestres" + "<br>" + 
                        truncateDecimals( period_formatter / 180, 2 ) + " semestres"  + "<br>" +
                        truncateDecimals( period_formatter / 360, 2 ) + " anos"       + "<br>"
                    );
                    $("#tax-tooltip").html(
                        truncateDecimals( convertTax( level == "basic", tax_formatted, 1  ), 2 ) + "% a.d." + "<br>" + 
                        truncateDecimals( convertTax( level == "basic", tax_formatted, 30 ), 2 ) + "% a.m." + "<br>" + 
                        truncateDecimals( convertTax( level == "basic", tax_formatted, 60 ), 2 ) + "% a.b." + "<br>" + 
                        truncateDecimals( convertTax( level == "basic", tax_formatted, 90 ), 2 ) + "% a.t." + "<br>" + 
                        truncateDecimals( convertTax( level == "basic", tax_formatted, 180), 2 ) + "% a.s." + "<br>" +
                        truncateDecimals( convertTax( level == "basic", tax_formatted, 360), 2 ) + "% a.a." + "<br>"
                    );

                    // Aplicar as máscaras
                    $("#amount" ).val( SimpleMaskMoney.formatToCurrency(amount , mask.type.amount)  );
                    $("#capital").val( SimpleMaskMoney.formatToCurrency(capital, mask.type.capital) );
                    $("#fees"   ).val( SimpleMaskMoney.formatToCurrency(fees   , mask.type.fees)    );
                    $("#tax"    ).val( SimpleMaskMoney.formatToCurrency(tax    , mask.type.tax)     );
                    $("#period" ).val( SimpleMaskMoney.formatToCurrency(period , mask.type.period)  );

                    $("#taxs").val(days_from_tax_selected).change();
                    $("#periods").val(days_from_period_selected).change();

                    refreshMasks()
                    enableFields(false)
                })
            
                $("#clear").click(function(e){
                    e.preventDefault();

                    $("#amount").val(0);
                    $("#capital").val(0);
                    $("#fees").val(0);
                    $("#tax").val("");
                    $("#period").val(0);

                    enableFields(true)
                    refreshMasks()
                })
            
                $("#basic").click(changeLevel);

                $("#advanced").click(changeLevel);

                $("#taxs").change( onChangeValidation )
                $("#periods").change( onChangeValidation )

                refreshMasks()
            })
        </script>
  	</body>
</hmtl>
